# API Documentation

## Содержание

- [Общая информация](#общая-информация)
- [API Endpoints](#api-endpoints)
  - [WebSocket соединение](#websocket-соединение)
  - [Форматы сообщений WebSocket](#форматы-сообщений-websocket)
  - [REST API эндпоинты](#rest-api-эндпоинты)
    - [Получение списка чатов](#получение-списка-чатов)
    - [Получение истории сообщений](#получение-истории-сообщений)
    - [Обновление статуса пользователя](#обновление-статуса-пользователя)
    - [Проверка статуса сервера](#проверка-статуса-сервера)
- [Форматы данных](#форматы-данных)
  - [Чат (Chat)](#чат-chat)
  - [Сообщение (Message)](#сообщение-message)
  - [Статус пользователя (UserStatus)](#статус-пользователя-userstatus)
- [Обработка ошибок](#обработка-ошибок)
- [Ограничения и лимиты](#ограничения-и-лимиты)
- [Примеры использования](#примеры-использования)
- [Детали реализации](#детали-реализации)
  - [Жизненный цикл WebSocket соединения](#жизненный-цикл-websocket-соединения)
  - [Протокол обмена сообщениями](#протокол-обмена-сообщениями)
  - [Обработка сообщений](#обработка-сообщений)
  - [Процесс обработки сжатия и шифрования](#процесс-обработки-сжатия-и-шифрования)
- [Архитектура системы](#архитектура-системы)
- [Рекомендации по использованию API](#рекомендации-по-использованию-api)
- [Версионирование API](#версионирование-api)

## Общая информация

Эта документация описывает API для системы чатов между покупателями и продавцами. API предоставляет доступ к функциям обмена сообщениями, получения списка чатов и управления статусами пользователей.

- **Версия API**: 1.0
- **Базовый URL**: `http://<host>:<port>/` или `https://<host>:<port>/` (для SSL)
- **Формат данных**: JSON
- **Аутентификация**: Токен в заголовке `Authorization` (для REST API)

## API Endpoints

### WebSocket соединение

#### Установка соединения

```
GET /ws/{userId}
```

**Параметры пути:**
- `userId` (int, обязательный) - ID пользователя, от имени которого устанавливается соединение

**Заголовки запроса:**
- `Authorization` (string, опционально) - Токен авторизации для дополнительной проверки

**Описание:**
Устанавливает WebSocket соединение для указанного пользователя. После установки соединения пользователь может обмениваться сообщениями в реальном времени.

**Пример:**
```
ws://localhost:8080/ws/123
```

**Коды ответов:**
- `101 Switching Protocols` - Успешное установление WebSocket соединения
- `401 Unauthorized` - Неавторизованный доступ
- `400 Bad Request` - Неверный формат запроса

### Форматы сообщений WebSocket

#### Отправка сообщения

```json
{
  "type": "message",
  "fromId": 123,
  "toId": 456,
  "productId": 789,
  "content": "Текст сообщения",
  "tempId": "temp_1623456789"
}
```

**Параметры:**
- `type` (string, обязательный) - Тип сообщения ("message")
- `fromId` (int, обязательный) - ID отправителя
- `toId` (int, обязательный) - ID получателя
- `productId` (int, обязательный) - ID товара, к которому относится сообщение
- `content` (string, обязательный) - Текст сообщения
- `tempId` (string, опционально) - Временный ID для отслеживания сообщения на клиенте

#### Подтверждение отправки сообщения (ответ сервера)

```json
{
  "type": "confirmation",
  "id": 12345,
  "tempId": "temp_1623456789",
  "status": "sent",
  "timestamp": "2023-06-15T14:23:45Z"
}
```

**Параметры:**
- `type` (string) - Тип сообщения ("confirmation")
- `id` (int) - ID сообщения, присвоенный сервером
- `tempId` (string) - Временный ID из оригинального сообщения
- `status` (string) - Статус обработки ("sent", "delivered", "read", "failed")
- `timestamp` (string) - Время обработки сообщения на сервере

#### Уведомление о статусе пользователя

```json
{
  "type": "status",
  "userId": 123,
  "status": "online",
  "isActive": true
}
```

**Параметры:**
- `type` (string, обязательный) - Тип сообщения ("status")
- `userId` (int, обязательный) - ID пользователя
- `status` (string, обязательный) - Статус пользователя ("online", "offline", "away")
- `isActive` (boolean, опционально) - Флаг активности пользователя

#### Уведомление о наборе текста

```json
{
  "type": "typing",
  "fromId": 123,
  "toId": 456,
  "productId": 789
}
```

**Параметры:**
- `type` (string, обязательный) - Тип сообщения ("typing")
- `fromId` (int, обязательный) - ID отправителя
- `toId` (int, обязательный) - ID получателя
- `productId` (int, обязательный) - ID товара

#### Отметка о прочтении сообщений

```json
{
  "type": "read",
  "fromId": 123,
  "toId": 456,
  "productId": 789,
  "lastReadId": 12345
}
```

**Параметры:**
- `type` (string, обязательный) - Тип сообщения ("read")
- `fromId` (int, обязательный) - ID отправителя уведомления
- `toId` (int, обязательный) - ID получателя уведомления
- `productId` (int, обязательный) - ID товара
- `lastReadId` (int, обязательный) - ID последнего прочитанного сообщения

### REST API эндпоинты

#### Получение списка чатов

```
GET /api/chats
```

**Параметры запроса:**
- `userId` или `user_id` (int, обязательный) - ID пользователя, для которого нужно получить список чатов
- `limit` (int, опционально) - Количество записей в ответе (по умолчанию 20, максимум 100)
- `offset` (int, опционально) - Смещение для пагинации (по умолчанию 0)
- `sortBy` (string, опционально) - Поле для сортировки ("lastMessage", "createdAt")
- `sortOrder` (string, опционально) - Порядок сортировки ("asc", "desc", по умолчанию "desc")

**Заголовки запроса:**
- `Authorization` (string, обязательный) - Токен авторизации в формате `Bearer <token>`

**Ответ:**
```json
{
  "chats": [
    {
      "id": 1,
      "buyerId": 123,
      "sellerId": 456,
      "productId": 789,
      "productTitle": "Смартфон Samsung Galaxy S21",
      "productImageUrl": "https://example.com/images/s21.jpg",
      "lastMessage": "Текст последнего сообщения",
      "lastMessageTime": "13:45",
      "lastMessageDate": "2023-06-15",
      "unreadCount": 2,
      "createdAt": "2023-04-10T15:04:05Z",
      "updatedAt": "2023-06-15T13:45:30Z"
    },
    ...
  ],
  "total": 42,
  "hasMore": true
}
```

**Коды ответов:**
- `200 OK` - Успешное выполнение запроса
- `400 Bad Request` - Отсутствуют обязательные параметры
- `401 Unauthorized` - Неавторизованный доступ
- `500 Internal Server Error` - Ошибка сервера при выполнении запроса

#### Получение истории сообщений

```
GET /api/messages
```

**Параметры запроса:**
- `userId` или `u_id` (int, обязательный) - ID пользователя, запрашивающего историю
- `chatWith` или `chat_with` (int, обязательный) - ID собеседника
- `productId` или `product_id` (int, опционально) - ID товара для фильтрации сообщений по конкретному товару
- `limit` (int, опционально) - Количество сообщений в ответе (по умолчанию 50, максимум 200)
- `before` (int, опционально) - ID сообщения, до которого нужно получить историю (для пагинации)
- `after` (int, опционально) - ID сообщения, после которого нужно получить историю (для пагинации)

**Заголовки запроса:**
- `Authorization` (string, обязательный) - Токен авторизации в формате `Bearer <token>`

**Ответ:**
```json
{
  "messages": [
    {
      "id": 1,
      "fromId": 123,
      "toId": 456,
      "productId": 789,
      "content": "Текст сообщения",
      "timestamp": "13:45",
      "date": "2023-06-15",
      "status": "read",
      "createdAt": "2023-04-10T15:04:05Z"
    },
    ...
  ],
  "hasMore": true,
  "nextCursor": 42
}
```

**Коды ответов:**
- `200 OK` - Успешное выполнение запроса
- `400 Bad Request` - Отсутствуют обязательные параметры
- `401 Unauthorized` - Неавторизованный доступ
- `500 Internal Server Error` - Ошибка сервера при выполнении запроса

#### Обновление статуса пользователя

```
POST /api/status
```

**Тело запроса:**
```json
{
  "userId": 123,
  "status": "online",
  "isActive": true
}
```

**Параметры:**
- `userId` (int, обязательный) - ID пользователя
- `status` (string, обязательный) - Статус пользователя ("online", "offline", "away")
- `isActive` (boolean, опционально) - Флаг активности пользователя

**Заголовки запроса:**
- `Authorization` (string, обязательный) - Токен авторизации в формате `Bearer <token>`
- `Content-Type` (string, обязательный) - Должен быть `application/json`

**Ответ:**
```json
{
  "success": true,
  "message": "Статус пользователя обновлен"
}
```

**Коды ответов:**
- `200 OK` - Успешное выполнение запроса
- `400 Bad Request` - Неверный формат запроса или отсутствуют обязательные параметры
- `401 Unauthorized` - Неавторизованный доступ
- `500 Internal Server Error` - Ошибка сервера при выполнении запроса

#### Проверка статуса сервера

```
GET /api/health
```

**Ответ:**
```json
{
  "status": "ok",
  "version": "1.0.0",
  "uptime": "10h 23m",
  "connections": 42
}
```

**Коды ответов:**
- `200 OK` - Сервер работает нормально
- `500 Internal Server Error` - Проблемы с сервером

## Форматы данных

### Чат (Chat)

| Поле             | Тип     | Описание                                    |
|------------------|---------|---------------------------------------------|
| id               | int     | Уникальный идентификатор чата              |
| buyerId          | int     | ID покупателя                              |
| sellerId         | int     | ID продавца                                |
| productId        | int     | ID товара, о котором ведется обсуждение    |
| productTitle     | string  | Название товара                            |
| productImageUrl  | string  | URL изображения товара                     |
| lastMessage      | string  | Текст последнего сообщения в чате          |
| lastMessageTime  | string  | Время последнего сообщения (форматированное)|
| lastMessageDate  | string  | Дата последнего сообщения (YYYY-MM-DD)     |
| unreadCount      | int     | Количество непрочитанных сообщений         |
| createdAt        | datetime| Дата и время создания чата                 |
| updatedAt        | datetime| Дата и время последнего обновления чата    |

### Сообщение (Message)

| Поле             | Тип     | Описание                                    |
|------------------|---------|---------------------------------------------|
| id               | int     | Уникальный идентификатор сообщения         |
| fromId           | int     | ID отправителя                             |
| toId             | int     | ID получателя                              |
| productId        | int     | ID товара, к которому относится сообщение  |
| content          | string  | Текст сообщения                            |
| timestamp        | string  | Отформатированное время отправки           |
| date             | string  | Дата отправки (YYYY-MM-DD)                 |
| status           | string  | Статус сообщения (sent, delivered, read)   |
| createdAt        | datetime| Точное время создания сообщения            |

### Статус пользователя (UserStatus)

| Поле             | Тип     | Описание                                    |
|------------------|---------|---------------------------------------------|
| userId           | int     | ID пользователя                             |
| status           | string  | Статус пользователя (online, offline, away) |
| isActive         | boolean | Флаг активности пользователя               |
| lastActivity     | datetime| Время последней активности                  |

## Обработка ошибок

Все API-эндпоинты в случае ошибки возвращают HTTP-код, соответствующий типу ошибки, и тело ответа в формате JSON:

```json
{
  "error": "Описание ошибки",
  "code": "ERROR_CODE",
  "details": {
    "field": "Описание ошибки в конкретном поле"
  }
}
```

### Коды ошибок

| Код HTTP | Код ошибки            | Описание                                |
|----------|----------------------|----------------------------------------|
| 400      | INVALID_PARAMETERS   | Неверные параметры запроса              |
| 401      | UNAUTHORIZED         | Не авторизован                          |
| 403      | FORBIDDEN            | Доступ запрещен                         |
| 404      | NOT_FOUND            | Ресурс не найден                        |
| 429      | TOO_MANY_REQUESTS    | Слишком много запросов                  |
| 500      | INTERNAL_SERVER_ERROR| Внутренняя ошибка сервера              |

## Ограничения и лимиты

- **Максимальный размер сообщения**: 512 KB
- **Таймаут бездействия для WebSocket-соединения**: 65 секунд
- **Период отправки ping-сообщений**: 54 секунды
- **Максимальное количество активных соединений на пользователя**: 5
- **Частота запросов к REST API**: не более 100 запросов в минуту
- **Максимальное количество сообщений в истории**: 10,000 на чат
- **Размер пагинации по умолчанию**: 20 для чатов, 50 для сообщений

## Примеры использования

### Пример получения списка чатов

```
GET /api/chats?userId=123&limit=10
```

### Пример получения истории сообщений

```
GET /api/messages?userId=123&chatWith=456&limit=100
```

### Пример отправки WebSocket сообщения и обработки ответа

```javascript
// Подключение к WebSocket
const ws = new WebSocket('ws://localhost:8080/ws/123');

// Отправка сообщения
const tempId = `temp_${Date.now()}`;
ws.send(JSON.stringify({
  type: 'message',
  fromId: 123,
  toId: 456,
  productId: 789,
  content: 'Здравствуйте! Товар ещё доступен?',
  tempId: tempId
}));

// Обработка подтверждения
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'confirmation' && data.tempId === tempId) {
    console.log(`Сообщение доставлено, присвоен ID: ${data.id}`);
  }
};
```

## Детали реализации

### Жизненный цикл WebSocket соединения

1. **Установка соединения**: Клиент подключается к `/ws/{userId}`
2. **Аутентификация**: Сервер проверяет валидность ID пользователя
3. **Регистрация**: Клиент регистрируется в системе и добавляется в список активных клиентов
4. **Обмен сообщениями**: Клиент отправляет и получает сообщения в реальном времени
5. **Пинг/Понг**: Сервер регулярно отправляет пинг-сообщения для поддержания соединения
6. **Завершение соединения**: При отключении клиента или таймауте бездействия соединение закрывается

### Протокол обмена сообщениями

#### Типы сообщений

1. **message** - Обычное текстовое сообщение между пользователями
   ```json
   {
     "type": "message",
     "fromId": 123,
     "toId": 456,
     "productId": 789,
     "content": "Текст сообщения"
   }
   ```

2. **status** - Обновление статуса пользователя
   ```json
   {
     "type": "status",
     "userId": 123,
     "status": "online",
     "isActive": true
   }
   ```

3. **typing** - Уведомление о наборе текста
   ```json
   {
     "type": "typing",
     "fromId": 123,
     "toId": 456,
     "productId": 789
   }
   ```

4. **read** - Отметка о прочтении сообщений
   ```json
   {
     "type": "read",
     "fromId": 123,
     "toId": 456,
     "productId": 789,
     "lastReadId": 12345
   }
   ```

5. **confirmation** - Подтверждение обработки сообщения
   ```json
   {
     "type": "confirmation",
     "id": 12345,
     "tempId": "temp_1623456789",
     "status": "sent",
     "timestamp": "2023-06-15T14:23:45Z"
   }
   ```

6. **error** - Сообщение об ошибке
   ```json
   {
     "type": "error",
     "code": "INVALID_MESSAGE",
     "content": "Описание ошибки"
   }
   ```

### Обработка сообщений 

1. Сообщение принимается через WebSocket
2. Происходит парсинг JSON
3. Проверяется тип сообщения
4. В зависимости от типа выполняется соответствующая обработка:
   - Для `message` - сохранение в БД и отправка получателю
   - Для `status` - обновление статуса пользователя и уведомление контактов
   - Для `typing` - передача уведомления получателю
   - Для `read` - обновление статуса прочтения в БД

### Процесс обработки сжатия и шифрования

Для обеспечения безопасности и оптимизации трафика, сообщения обрабатываются через процессорный конвейер:

1. **Сжатие** - Сообщения сжимаются алгоритмом snappy для уменьшения объема передаваемых данных
2. **Шифрование** - Сжатые данные шифруются с использованием AES-256 для обеспечения безопасности
3. **Отправка** - Защищенные данные передаются через WebSocket

При получении сообщения происходит обратный процесс:
1. **Дешифрование** - Расшифровка зашифрованных данных 
2. **Распаковка** - Распаковка сжатых данных
3. **Обработка** - Обработка полученного сообщения

## Архитектура системы

### Компоненты системы

1. **WebSocket сервер** - Обрабатывает real-time соединения
2. **HTTP API** - Обрабатывает REST запросы
3. **Процессор сообщений** - Выполняет сжатие/шифрование 
4. **Слой доступа к БД** - Взаимодействует с базой данных MySQL

### Схема взаимодействия компонентов

```
Клиент <----> WebSocket <----> Процессор <----> БД
  ^            ^
  |            |
  +------------+
       HTTP
```

## Рекомендации по использованию API

1. Перед отправкой сообщений всегда проверяйте статус пользователя через эндпоинт `/api/status`
2. При отсутствии сообщений в течение длительного времени рекомендуется отправлять пинг-запросы
3. Размер сообщений не должен превышать 512 КБ
4. При ошибках соединения рекомендуется использовать экспоненциальный backoff для повторных попыток
5. Для мобильных клиентов рекомендуется использовать сжатие данных для экономии трафика
6. Всегда обрабатывайте подтверждения (`confirmation`) для отправленных сообщений
7. Используйте временные ID (`tempId`) для отслеживания отправленных сообщений

## Версионирование API

Текущая версия API: **1.0**

При необходимости обратной несовместимых изменений, версия API будет инкрементирована (например, 1.1, 2.0). 
Новые версии API будут доступны по URL с указанием версии:

```
/api/v2/chats
/api/v2/messages
```

Версия 1.0 будет поддерживаться как минимум в течение 12 месяцев после выпуска новой версии. 