# Модуль линейной регрессии для прогнозирования трендов активности

Модуль реализует прогнозирование трендов активности пользователей в системе с помощью метода линейной регрессии. Основная цель - выявление общего тренда и прогнозирование будущей активности на основе исторических данных.

## Теоретическая основа

Линейная регрессия позволяет моделировать зависимость количества сообщений (Y) от времени (X) в виде линейной функции:

```
Y = aX + b
```

где `a` и `b` — коэффициенты, определяющие наклон линии и её смещение соответственно.

### Оценка линейной связи: коэффициент корреляции Пирсона

Коэффициент корреляции Пирсона (r) — статистическая мера, показывающая силу и направление линейной связи между временем и количеством сообщений.

Математическая формула:
```
r = sum((x_i - x̄)(y_i - ȳ)) / (sqrt(sum((x_i - x̄)²)) * sqrt(sum((y_i - ȳ)²)))
```

Интерпретация:
- r ≈ 1: сильная положительная линейная связь (чем больше времени, тем больше сообщений)
- r ≈ -1: сильная отрицательная линейная связь (чем больше времени, тем меньше сообщений)
- r ≈ 0: линейной связи практически нет

### Коэффициент детерминации (R²)

Коэффициент детерминации показывает, какая доля дисперсии объясняется моделью. Для простой линейной регрессии:

```
R² = r²
```

## Структура модуля

Модуль состоит из следующих компонентов:

- **models.go** - определение структур данных для регрессии
- **regression.go** - основная логика расчёта регрессии
- **repository.go** - работа с базой данных для хранения прогнозов
- **data_service.go** - получение данных из OLAP-куба
- **regression_processor.go** - основной процессор регрессии
- **run_lr.sh** - shell-скрипт для запуска как отдельной утилиты

## Интеграция с ETL-процессом

Модуль линейной регрессии интегрирован в основной ETL-процесс и выполняет следующие шаги:

1. Извлечение данных о ежедневной активности из таблицы `daily_activity_facts`
2. Расчёт коэффициентов линейной регрессии и коэффициента корреляции Пирсона
3. Оценка качества модели через коэффициент детерминации (R²)
4. Построение прогнозов на будущие периоды с доверительными интервалами
5. Сохранение результатов в таблицу `activity_trend_predictions`

## Использование

### Как часть ETL-процесса

Линейная регрессия автоматически выполняется после завершения основного ETL-процесса.

### Как отдельная утилита

#### Вариант 1: Shell-скрипт (рекомендуется)

Модуль может быть запущен отдельно с помощью shell-скрипта:

```bash
./run_lr.sh [опции]
```

Опции:
- `-d, --days ЧИСЛО` - количество дней для анализа (по умолчанию: 30)
- `-f, --forecast ЧИСЛО` - количество дней для прогноза (по умолчанию: 14)
- `-c, --confidence ЧИСЛО` - уровень доверия (0.90, 0.95, 0.99) (по умолчанию: 0.95)
- `-r, --min-r2 ЧИСЛО` - минимальный порог для R² (по умолчанию: 0.30)
- `-h, --help` - показать справку

#### Вариант 2: Прямой запуск через Go

Альтернативно, можно использовать прямой запуск через Go:

```bash
cd ..  # Перейти в корневую директорию ETL
go run etl_runner.go -mode=lr -days=30 -forecast=14 -confidence=0.95 -min-r2=0.30
```

## Результаты

Результаты прогнозирования сохраняются в таблице `activity_trend_predictions` и могут быть использованы для:

1. Визуализации трендов активности
2. Планирования нагрузки на систему
3. Выявления аномалий в активности пользователей
4. Принятия бизнес-решений на основе прогнозов

## Математическое обоснование

### Линейная регрессия (метод наименьших квадратов)

```
a = (n*sum(x_i*y_i) - sum(x_i)*sum(y_i)) / (n*sum(x_i²) - (sum(x_i))²)
b = (sum(y_i) - a*sum(x_i)) / n
```

### Коэффициент корреляции Пирсона (r)

```
r = (n*sum(x_i*y_i) - sum(x_i)*sum(y_i)) / sqrt((n*sum(x_i²) - (sum(x_i))²) * (n*sum(y_i²) - (sum(y_i))²))
```

### Коэффициент детерминации (R²)

```
R² = r²
```

### Стандартная ошибка оценки

```
SE = sqrt(sum((y_i - ŷ_i)²) / (n - 2))
```

### Доверительный интервал

```
CI = ŷ ± t * SE * sqrt(1 + 1/n + (x - x̄)²/sum((x_i - x̄)²))
```

где `t` - значение t-статистики для выбранного уровня доверия.

### Округление результатов

Для лучшей читаемости и работы с данными, все числовые значения округляются до тысячных (3 знака после запятой) перед сохранением в базу данных:

```
RoundedValue = round(value * 1000) / 1000
```

Округление применяется ко всем рассчитываемым значениям:
- Коэффициентам линейной регрессии (a и b)
- Коэффициенту корреляции Пирсона (r)
- Коэффициенту детерминации (R²)
- Прогнозным значениям
- Границам доверительного интервала 