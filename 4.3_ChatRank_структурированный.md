# 4.3 ChatRank: Модификация алгоритма PageRank для ранжирования влиятельности пользователей в чатах

## 1. Анализ и постановка задачи

В процессе анализа коммуникационных данных в чат-системах было выявлено, что стандартные метрики активности (количество сообщений, частота взаимодействий) не позволяют в полной мере оценить реальное влияние пользователей на общую коммуникационную динамику. Существующие подходы к оценке важности узлов в графах, такие как классический алгоритм PageRank, не учитывают многомерные аспекты коммуникаций, характерные для чат-систем.

**Задача**: Разработать алгоритм для ранжирования пользователей по степени их влиятельности в системе чатов, учитывающий не только количественные, но и качественные характеристики коммуникаций.

**Требования к алгоритму**:
1. Учитывать разнообразные аспекты коммуникаций (скорость ответа, полнота ответов, информативность)
2. Обеспечивать сходимость при итеративных вычислениях
3. Предоставлять интерпретируемые результаты для последующего анализа
4. Интегрироваться с существующей ETL-системой и OLAP-хранилищем

## 2. Построение модели

Для решения поставленной задачи была предложена модель взвешенного направленного графа коммуникаций, где:

- **Узлы графа**: Пользователи системы
- **Направленные рёбра**: Коммуникационные связи от одного пользователя к другому
- **Веса рёбер**: Многомерная оценка качества и интенсивности коммуникации

Модель предполагает, что влиятельность пользователя определяется не только количеством получаемых сообщений, но и тем, от кого они получены, а также качественными характеристиками этих взаимодействий.

Для формализации модели используется модификация классического алгоритма PageRank, где ранг влиятельности пользователя CR(u) определяется формулой:

CR(u) = (1-d) + d ∑(v∈I(u))(CR(v)⋅W(v,u))/(O(v))

где:
- CR(u) — ранг влиятельности пользователя u
- d — коэффициент затухания (0.85)
- I(u) — множество пользователей, отправлявших сообщения пользователю u
- CR(v) — ранг пользователя v
- W(v,u) — вес коммуникационной связи от v к u
- O(v) — сумма весов всех исходящих связей от пользователя v

В отличие от классического PageRank, веса связей W(v,u) определяются не просто количеством сообщений, а взвешенной комбинацией четырех ключевых факторов:

W(v,u) = α⋅T(v,u) + β⋅R(v,u) + γ⋅L(v,u) + δ⋅M(v,u)

где:
- T(v,u) — временной фактор (скорость ответа)
- R(v,u) — фактор частоты ответов
- L(v,u) — фактор длины сообщений
- M(v,u) — фактор количества сообщений
- α, β, γ, δ — веса значимости каждого фактора (в сумме 1)

## 3. Разработка алгоритма

Алгоритм ChatRank состоит из следующих шагов:

1. **Инициализация**:
   - Извлечение данных о коммуникациях из OLAP-хранилища
   - Начальное присвоение равных рангов всем пользователям (1/n, где n — количество пользователей)
   - Установка параметров: коэффициент затухания, веса факторов, порог сходимости, максимальное число итераций

2. **Построение графа коммуникаций**:
   - Для каждой пары пользователей (v, u), где v отправлял сообщения u:
     - Расчет временного фактора T(v,u) = exp(-0.01⋅AvgResponseTime(v,u))
     - Расчет фактора частоты ответов R(v,u) = ResponseCount(v,u)/MessageCount(v,u)
     - Расчет фактора длины сообщений L(v,u) = 0.5 + 0.5⋅min(AvgMessageLength(v,u)/50, 2)
     - Расчет фактора количества сообщений M(v,u) = 1.5⋅√(MessageCount(v,u))/√7
     - Вычисление общего веса связи W(v,u) = α⋅T(v,u) + β⋅R(v,u) + γ⋅L(v,u) + δ⋅M(v,u)
   - Для каждого пользователя v расчет суммы весов исходящих связей O(v)

3. **Итеративное вычисление рангов**:
   - Повторять до достижения сходимости или максимального числа итераций:
     - Для каждого пользователя u вычислить новый ранг:
       CR_new(u) = (1-d) + d⋅∑(v∈I(u))(CR_old(v)⋅W(v,u))/(O(v))
     - Вычислить дельту между новыми и старыми рангами Δ = max|CR_new(u) - CR_old(u)|
     - Если Δ < ε (порог сходимости), завершить итерации
     - Заменить старые ранги новыми: CR_old = CR_new

4. **Нормализация и категоризация**:
   - Нормализовать ранги для удобства интерпретации
   - Распределить пользователей по категориям влияния:
     - "high": процентиль ≥ 0.9 (верхние 10%)
     - "medium": 0.5 ≤ процентиль < 0.9 (от 50% до 90%)
     - "low": процентиль < 0.5 (нижние 50%)

5. **Сохранение результатов**:
   - Записать ранги и категории пользователей в таблицу user_influence_rank
   - Сохранить веса коммуникационных связей в таблицу communication_weights

## 4. Проверка правильности алгоритма

Проверка правильности алгоритма проводилась по следующим критериям:

1. **Математическая корректность**:
   - Сходимость алгоритма при различных входных данных
   - Соответствие свойству суммы рангов (сумма всех рангов после нормализации равна 1)

2. **Семантическая валидность**:
   - Соответствие результатов ранжирования интуитивным ожиданиям
   - Пользователи с большим количеством качественных входящих связей должны иметь более высокий ранг

3. **Устойчивость результатов**:
   - Незначительные изменения входных данных не должны приводить к радикальному изменению рангов
   - Стабильность результатов при незначительных изменениях параметров алгоритма

4. **Интерпретируемость результатов**:
   - Понятное распределение пользователей по категориям влияния
   - Возможность объяснить высокий/низкий ранг конкретного пользователя

В ходе тестирования на реальных данных было подтверждено, что алгоритм:
- Стабильно сходится в среднем за 50 итераций
- Корректно выявляет наиболее влиятельных пользователей, что подтверждается экспертной оценкой
- Обеспечивает устойчивые результаты при небольших изменениях входных данных

## 5. Реализация алгоритма в виде программы

Алгоритм ChatRank реализован на языке Go в виде отдельного модуля в рамках ETL-системы. Реализация включает следующие основные компоненты:

1. **Структура данных** (`models.go`):
   - `ChatRankConfig` — конфигурация алгоритма с параметрами
   - `UserRank` — структура для хранения ранга пользователя
   - `CommunicationWeight` — структура для хранения весов связей и их компонентов
   - `UserPercentile` — структура для хранения процентильного положения пользователя

2. **Основной алгоритм** (`chatrank.go`):
   - Функция `CalculateChatRank()` — реализация алгоритма итеративного вычисления рангов
   - Функция `CalculateWeights()` — вычисление весов коммуникационных связей
   - Функция `CategorizeUsers()` — распределение пользователей по категориям влияния

3. **Сервис доступа к данным** (`data_service.go`):
   - Функции для извлечения данных о коммуникациях из OLAP-хранилища
   - Методы для агрегации коммуникационных метрик

4. **Репозиторий** (`repository.go`):
   - Функции для сохранения результатов расчета в OLAP-базу данных
   - Создание и обновление таблиц для хранения результатов

5. **Процессор** (`chatrank_processor.go`):
   - Координация выполнения всех этапов алгоритма
   - Обработка ошибок и логирование
   - Интеграция с общей ETL-системой

Алгоритм вызывается из основного ETL-процесса (`etl_runner.go`) после завершения загрузки данных в OLAP-хранилище. Это обеспечивает актуальность результатов ранжирования при каждом обновлении данных. 

Конфигурационные параметры могут быть заданы при запуске через командную строку, что позволяет экспериментировать с различными настройками алгоритма.

## 6. Анализ алгоритма и его сложности

**Временная сложность** алгоритма ChatRank можно разделить на несколько компонентов:

1. **Извлечение данных**: O(m), где m — количество сообщений. Эта операция линейно зависит от объема данных в базе.

2. **Построение графа и вычисление весов**: O(e), где e — количество рёбер (уникальных пар отправитель-получатель). В худшем случае e ~ n², где n — количество пользователей, но на практике граф коммуникаций значительно разрежен.

3. **Итеративное вычисление рангов**: O(i·e), где i — количество итераций до сходимости. Каждая итерация требует обхода всех рёбер графа.

4. **Нормализация и категоризация**: O(n·log(n)) из-за необходимости сортировки для вычисления процентилей.

5. **Сохранение результатов**: O(n + e) для записи рангов пользователей и весов коммуникационных связей.

Общая временная сложность алгоритма: O(m + i·e + n·log(n))

**Пространственная сложность**: O(n + e) для хранения рангов пользователей и весов связей.

**Факторы, влияющие на производительность**:
- Количество пользователей и связей между ними
- Порог сходимости (более строгий порог требует больше итераций)
- Эффективность доступа к базе данных (часто является узким местом)

На основе анализа логов выполнения при обработке реальных данных (4367 сообщений, 499 отправителей) было установлено:
- Алгоритм сходится за ~52 итерации с порогом 0.0001
- Общее время выполнения составляет около 20 секунд, из которых 95% тратится на запросы к базе данных
- Сам процесс вычисления рангов занимает менее 25 миллисекунд

Таким образом, алгоритм демонстрирует хорошую вычислительную эффективность, и основным фактором, ограничивающим производительность, является взаимодействие с базой данных.

## 7. Проверка программы

Тестирование реализации алгоритма ChatRank проводилось по следующим направлениям:

1. **Функциональное тестирование**:
   - Корректность расчета весов коммуникационных связей
   - Правильность итеративного вычисления рангов
   - Точность распределения пользователей по категориям

2. **Интеграционное тестирование**:
   - Взаимодействие с OLAP-хранилищем для получения данных
   - Корректность сохранения результатов
   - Интеграция с основным ETL-процессом

3. **Нагрузочное тестирование**:
   - Обработка большого объема коммуникационных данных
   - Оценка времени выполнения и потребления ресурсов

4. **Параметрическое тестирование**:
   - Проверка работы алгоритма при различных значениях параметров
   - Оценка влияния параметров на результаты ранжирования

Результаты тестирования показали, что:
- Программная реализация корректно выполняет все этапы алгоритма
- Расчет рангов влиятельности соответствует теоретической модели
- Алгоритм устойчив к изменениям параметров и входных данных
- Программа корректно интегрируется с общей ETL-системой
- При больших объемах данных наблюдается линейный рост времени выполнения, что соответствует теоретической оценке сложности

## 8. Составление документации

Документация по алгоритму ChatRank включает в себя:

1. **Общее описание**:
   - Цель и назначение алгоритма
   - Теоретическая основа и отличия от классического PageRank
   - Преимущества применения для анализа коммуникационных данных

2. **Математическая модель**:
   - Формальное описание алгоритма и его компонентов
   - Формулы для расчета факторов и весов связей
   - Условия сходимости алгоритма

3. **Программная реализация**:
   - Структура кода и основные компоненты
   - Параметры конфигурации и их значения по умолчанию
   - Интеграция с ETL-системой

4. **Инструкция по использованию**:
   - Запуск алгоритма через интерфейс командной строки
   - Настройка параметров для оптимизации результатов
   - Интерпретация полученных рангов и категорий пользователей

5. **Примеры применения**:
   - Анализ влиятельности пользователей в системе чатов
   - Выявление ключевых участников коммуникации
   - Интеграция результатов с другими аналитическими данными

6. **Возможности расширения**:
   - Добавление новых факторов в модель весов связей
   - Оптимизация производительности для больших объемов данных
   - Визуализация результатов ранжирования

Вся документация интегрирована в общую документацию ETL-системы и доступна как в виде комментариев в коде, так и в виде отдельного README.md файла в директории модуля.

## Заключение

Алгоритм ChatRank представляет собой эффективное решение для ранжирования пользователей по их влиятельности в системе чатов. Он успешно адаптирует идеи классического алгоритма PageRank к специфике коммуникационных данных, учитывая многомерные характеристики взаимодействий между пользователями.

Реализация алгоритма в виде модуля ETL-системы обеспечивает регулярное обновление рангов влиятельности при каждом пополнении данных, что позволяет отслеживать динамику изменения коммуникационных паттернов и выявлять ключевых участников общения.

В дальнейшем планируется расширение алгоритма для учета содержания сообщений и контекста коммуникаций, что потенциально повысит точность ранжирования пользователей по их реальному влиянию на коммуникационные процессы. 